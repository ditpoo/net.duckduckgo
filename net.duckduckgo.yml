app-id: com.duckduckgo.mobile.android
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Platform
base: io.gitlab.android_translation_layer.BaseApp
base-version: stable
command: duckduckgo.sh
environment:
  ANDROID_ART_DISABLE_IMAGE: "1"
  ANDROID_ART_NO_DEX2OAT: "1"
  ANDROID_ART_IMAGE: "0"
  ANDROID_ART_USE_OPTIMIZING_COMPILER: "false"
  ANDROID_ART_CACHE: /run/art-cache
finish-args:
  - --share=network
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --socket=pulseaudio
  - --env=ANDROID_ART_DISABLE_IMAGE=1
  - --env=ANDROID_ART_NO_DEX2OAT=1
  - --env=ANDROID_ART_IMAGE=0
  - --env=ANDROID_ART_USE_OPTIMIZING_COMPILER=false
  - --env=ANDROID_ART_USE_JIT=true    # o
  - --env=ANDROID_ART_CACHE=/run/art-cache
modules:
  - name: duckduckgo
    buildsystem: simple
    build-commands:
      - install -D com.duckduckgo.mobile.android_52541000.apk /app/share/duckduckgo.apk
      - install -D duckduckgo.sh /app/bin/duckduckgo.sh
      - install -D net.duckduckgo.desktop /app/share/applications/net.duckduckgo.desktop
      # - install -D logo.svg /app/share/icons/hicolor/scalable/apps/net.duckduckgo.svg
      - install -D net.duckduckgo.metainfo.xml /app/share/metainfo/net.duckduckgo.metainfo.xml
    sources:
      - type: file
        url: https://f-droid.org/repo/com.duckduckgo.mobile.android_52541000.apk
        sha256: 93afce29a7558b494ac3efaf489bb876b0523ecda6b5ac8c3fc581df32c2ddec
      # - type: file
      #   url: https://duckduckgo.net/img/logo.svg
      #   sha256: dcbdc537ef9937225df96f97a571a5deb2e5dde021c687530b7ee165c5c67cb7
      - type: file
        path: duckduckgo.sh
      - type: file
        path: net.duckduckgo.desktop
      - type: file
        path: net.duckduckgo.metainfo.xml

  - name: run-dex2oat
    buildsystem: simple
    build-options:
      append-ld-library-path: /app/lib/art:/app/lib
      arch:
        x86_64:
          env:
            arch: x86_64
        aarch64:
          env:
            arch: arm64
    build-commands:
      - mkdir -p /app/share/oat/$arch
      - dex2oat --dex-file=/app/share/duckduckgo.apk --oat-file=/app/share/oat/$arch/duckduckgo.odex --host --instruction-set=x86_64 --boot-image=
      - chmod +x /app/share/oat/$arch/duckduckgo.odex
      - mv /app/share/duckduckgo.apk duckduckgo.apk
      - zip -d duckduckgo.apk "classes*.dex"
      - mv duckduckgo.apk /app/share/duckduckgo.apk

  - name: remove-dex2oat
    buildsystem: simple
    build-commands:
      - rm /app/lib/art/libart-compiler.so
      - rm /app/lib/art/libart-dexlayout.so
      - rm /app/bin/dex2oat
      - rm /app/bin/dalvikvm
